import os
import telebot
import requests
import time

# ===== CONFIGURA√á√ïES =====

TOKEN = os.getenv("TOKEN")  # Coloque no Render como vari√°vel de ambiente
LNBITS_URL = "https://demo.lnbits.com"
INVOICE_KEY = os.getenv("INVOICE_KEY")  # Tamb√©m colocar no Render
LINK_EBOOK = "https://drive.google.com/file/d/1hkt-22oQHgpk9tEPZeSiGJNz7MKHsCw7/view?usp=drivesdk"

if not TOKEN:
    raise ValueError("TOKEN n√£o encontrado nas vari√°veis de ambiente")

if not INVOICE_KEY:
    raise ValueError("INVOICE_KEY n√£o encontrada nas vari√°veis de ambiente")

bot = telebot.TeleBot(TOKEN)

# ===== COMANDO START =====

@bot.message_handler(commands=['start'])
def start(message):
    markup = telebot.types.InlineKeyboardMarkup()
    botao = telebot.types.InlineKeyboardButton(
        "üìò Comprar - 2 sats",
        callback_data="comprar"
    )
    markup.add(botao)

    bot.send_message(
        message.chat.id,
        "üå≥ *Bitcoin no Mundo Animal*\n\n"
        "Pre√ßo: *2 sats*\n\n"
        "Clique abaixo para comprar:",
        reply_markup=markup,
        parse_mode="Markdown"
    )

# ===== GERAR INVOICE =====

@bot.callback_query_handler(func=lambda call: call.data == "comprar")
def gerar_invoice(call):

    bot.answer_callback_query(call.id)
    chat_id = call.message.chat.id

    bot.send_message(chat_id, "‚ö° Gerando invoice...")

    headers = {
        "X-Api-Key": INVOICE_KEY,
        "Content-type": "application/json"
    }

    data = {
        "out": False,
        "amount": 2,
        "memo": "Compra Ebook Bitcoin no Mundo Animal"
    }

    try:
        response = requests.post(
            f"{LNBITS_URL}/api/v1/payments",
            json=data,
            headers=headers,
            timeout=10
        )
    except requests.exceptions.RequestException:
        bot.send_message(chat_id, "‚ùå Erro de conex√£o com LNBits.")
        return

    if response.status_code != 201:
        bot.send_message(chat_id, "‚ùå Erro ao gerar invoice.")
        print(response.text)
        return

    resultado = response.json()
    payment_request = resultado.get("payment_request")
    checking_id = resultado.get("checking_id")

    bot.send_message(chat_id, "‚ö° Pague esta invoice:")
    bot.send_message(chat_id, payment_request)
    bot.send_message(chat_id, "‚è≥ Aguardando pagamento...")

    # Verifica pagamento por at√© 2 minutos e meio
    for _ in range(30):
        time.sleep(5)

        check_response = requests.get(
            f"{LNBITS_URL}/api/v1/payments/{checking_id}",
            headers=headers
        )

        if check_response.status_code == 200:
            if check_response.json().get("paid"):

                bot.send_message(
                    chat_id,
                    "üéâ *Pagamento confirmado!*\n\n"
                    "üìò Seu ebook est√° dispon√≠vel abaixo:",
                    parse_mode="Markdown"
                )

                bot.send_message(chat_id, LINK_EBOOK)
                return

    bot.send_message(
        chat_id,
        "‚ö†Ô∏è Tempo de pagamento expirado.\nEnvie /start para tentar novamente."
    )

print("Bot Lightning iniciado...")
bot.infinity_polling()
