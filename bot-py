import telebot
import requests
import time

TOKEN = "8204445380:AAHcjru31PV3Vfz15s41TtqyDHrSFGGHuI8"

LNBITS_URL = "https://demo.lnbits.com"
INVOICE_KEY = "052a72b8573f493182e13353c93a22fa"

LINK_EBOOK = "https://drive.google.com/file/d/1hkt-22oQHgpk9tEPZeSiGJNz7MKHsCw7/view?usp=drivesdk"

bot = telebot.TeleBot(TOKEN)

@bot.message_handler(commands=['start'])
def start(message):
    markup = telebot.types.InlineKeyboardMarkup()
    botao = telebot.types.InlineKeyboardButton("üìò Comprar - 2 sats", callback_data="comprar")
    markup.add(botao)

    bot.send_message(
        message.chat.id,
        "üå≥ Bitcoin no Mundo Animal\n\nPre√ßo: 2 sats\n\nClique abaixo para comprar:",
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data == "comprar")
def gerar_invoice(call):

    bot.answer_callback_query(call.id)
    chat_id = call.message.chat.id

    bot.send_message(chat_id, "‚ö° Gerando invoice...")

    headers = {
        "X-Api-Key": INVOICE_KEY,
        "Content-type": "application/json"
    }

    data = {
        "out": False,
        "amount": 2,
        "memo": "Compra Ebook Bitcoin no Mundo Animal"
    }

    response = requests.post(
        f"{LNBITS_URL}/api/v1/payments",
        json=data,
        headers=headers
    )

    if response.status_code != 201:
        bot.send_message(chat_id, "‚ùå Erro ao gerar invoice.")
        print(response.text)
        return

    resultado = response.json()
    payment_request = resultado.get("payment_request")
    checking_id = resultado.get("checking_id")

    bot.send_message(chat_id, "‚ö° Pague esta invoice:")
    bot.send_message(chat_id, f"{payment_request}", parse_mode="Markdown")
    bot.send_message(chat_id, "‚è≥ Aguardando pagamento...")

    # verifica por at√© 2 minutos e meio
    for _ in range(30):
        time.sleep(5)

        check_response = requests.get(
            f"{LNBITS_URL}/api/v1/payments/{checking_id}",
            headers=headers
        )

        if check_response.status_code == 200:
            if check_response.json().get("paid"):

                bot.send_message(
                    chat_id,
                    "üéâ Pagamento confirmado!\n\n"
                    "üìò Seu ebook est√° dispon√≠vel abaixo:"
                )

                bot.send_message(chat_id, LINK_EBOOK)
                return

    bot.send_message(chat_id, "‚ö†Ô∏è Tempo de pagamento expirado. Envie /start para tentar novamente.")

print("Bot Lightning iniciado...")
bot.infinity_polling()
